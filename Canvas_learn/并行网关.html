<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script>
        const dataObj = {
            "elements": [
                {
                    "completed": true,
                    "current": false,
                    "id": "startEvent1",
                    "name": null,
                    "x": 100,
                    "y": 163,
                    "width": 30,
                    "height": 30,
                    "type": "StartEvent",
                    "properties": []
                },
                {
                    "completed": true,
                    "current": false,
                    "id": "sid-46C7F9E2-2349-4DA2-B72D-8CB36350C57B",
                    "name": "项目立项申请",
                    "x": 180,
                    "y": 138,
                    "width": 100,
                    "height": 80,
                    "type": "UserTask",
                    "properties": [
                        {
                            "name": "Assignee",
                            "value": "${initiator}"
                        },
                        {
                            "name": "Form key",
                            "value": "事件_项目管理_流程审批表"
                        }
                    ]
                },
                {
                    "completed": true,
                    "current": false,
                    "id": "sid-211B2FB8-DD59-4B41-A665-4DE5824DB05D",
                    "name": "部门领导审核",
                    "x": 330,
                    "y": 138,
                    "width": 100,
                    "height": 80,
                    "type": "UserTask",
                    "properties": [
                        {
                            "name": "Assignee",
                            "value": "${initiator}"
                        },
                        {
                            "name": "Form key",
                            "value": "事件_项目管理_流程审批表"
                        }
                    ]
                },
                {
                    "completed": true,
                    "current": false,
                    "id": "sid-EB47CBAD-D3D1-4E24-9453-E77DCC086EC4",
                    "name": null,
                    "x": 555,
                    "y": 158,
                    "width": 40,
                    "height": 40,
                    "type": "ParallelGateway"
                },
                {
                    "completed": false,
                    "current": true,
                    "id": "sid-CDCDDC6A-9E86-4B8F-B53E-B3CDBC0B3BBB",
                    "name": "财务部审批",
                    "x": 645,
                    "y": 135,
                    "width": 100,
                    "height": 80,
                    "type": "UserTask",
                    "properties": [
                        {
                            "name": "Assignee",
                            "value": "wangwanli"
                        },
                        {
                            "name": "Form key",
                            "value": "事件_项目管理_流程审批表"
                        }
                    ]
                },
                {
                    "completed": false,
                    "current": true,
                    "id": "sid-1E891955-23D7-4B03-B0F2-20E01C916F2F",
                    "name": "技术部审批",
                    "x": 645,
                    "y": 255,
                    "width": 100,
                    "height": 80,
                    "type": "UserTask",
                    "properties": [
                        {
                            "name": "Assignee",
                            "value": "dengxiaofeng"
                        },
                        {
                            "name": "Form key",
                            "value": "事件_项目管理_流程审批表"
                        }
                    ]
                },
                {
                    "completed": false,
                    "current": true,
                    "id": "sid-C82CF27E-20E6-41D9-BC15-FAF848337837",
                    "name": "工程部审批",
                    "x": 645,
                    "y": 30,
                    "width": 100,
                    "height": 80,
                    "type": "UserTask",
                    "properties": [
                        {
                            "name": "Assignee",
                            "value": "zhengyue"
                        },
                        {
                            "name": "Form key",
                            "value": "事件_项目管理_流程审批表"
                        }
                    ]
                },
                {
                    "completed": false,
                    "current": false,
                    "id": "sid-ABD91174-23BB-4459-87E4-39755F345335",
                    "name": null,
                    "x": 855,
                    "y": 158,
                    "width": 40,
                    "height": 40,
                    "type": "ParallelGateway"
                },
                {
                    "completed": false,
                    "current": false,
                    "id": "sid-C2104CBB-69A4-4B77-8751-9E5F4493A48C",
                    "name": "总经理审批",
                    "x": 945,
                    "y": 138,
                    "width": 100,
                    "height": 80,
                    "type": "UserTask",
                    "properties": [
                        {
                            "name": "Assignee",
                            "value": "${initiator}"
                        },
                        {
                            "name": "Form key",
                            "value": "事件_项目管理_流程审批表"
                        }
                    ]
                },
                {
                    "completed": false,
                    "current": false,
                    "id": "sid-E28221D3-D54F-4C09-B16A-9257D82F0903",
                    "name": null,
                    "x": 1095,
                    "y": 164,
                    "width": 28,
                    "height": 28,
                    "type": "EndEvent",
                    "properties": []
                }
            ]
        }
        let list = [
  {
    "Comment": null,
    "DeleteReason": "",
    "ETime": "2021/8/11 10:23:05",
    "GoBackReason": "",
    "OperationMan": "wangwanli",
    "STime": "2021/8/11 10:23:04",
    "State": "提交",
    "TaskID": "0efbdbde-fa4b-11eb-8a61-00ff0230fa40",
    "TaskName": "项目立项申请"
  },
  {
    "Comment": null,
    "DeleteReason": "",
    "ETime": "2021/8/11 10:23:28",
    "GoBackReason": "",
    "OperationMan": "wangwanli",
    "STime": "2021/8/11 10:23:05",
    "State": "提交",
    "TaskID": "0fa9cf25-fa4b-11eb-8a61-00ff0230fa40",
    "TaskName": "部门领导审核"
  },
  {
    "Comment": null,
    "DeleteReason": "",
    "ETime": "2021/8/11 12:50:26",
    "GoBackReason": "",
    "OperationMan": "wangwanli",
    "STime": "2021/8/11 10:23:29",
    "State": "提交",
    "TaskID": "1d9a8907-fa4b-11eb-8a61-00ff0230fa40",
    "TaskName": "财务部审批"
  },
  {
    "Comment": null,
    "DeleteReason": "",
    "ETime": "2021/8/11 12:51:15",
    "GoBackReason": "",
    "OperationMan": "dengxiaofeng",
    "STime": "2021/8/11 10:23:29",
    "State": "提交",
    "TaskID": "1d9ab01a-fa4b-11eb-8a61-00ff0230fa40",
    "TaskName": "技术部审批"
  },
  {
    "Comment": null,
    "DeleteReason": "",
    "ETime": "2021/8/11 13:00:03",
    "GoBackReason": "",
    "OperationMan": "zhengyue",
    "STime": "2021/8/11 10:23:29",
    "State": "提交",
    "TaskID": "1d9ab01e-fa4b-11eb-8a61-00ff0230fa40",
    "TaskName": "工程部审批"
  },
  {
    "Comment": null,
    "DeleteReason": "",
    "ETime": "",
    "GoBackReason": "",
    "OperationMan": "wangwanli",
    "STime": "2021/8/11 13:00:03",
    "State": "进行中",
    "TaskID": "fd2c3881-fa60-11eb-8a61-00ff0230fa40",
    "TaskName": "总经理审批"
  }
]
        /**
         * 1，判断是否存在并行网关，type为ParallelGateway，截取ParallelGateway之间的节点，根据个数设置为并行节点个数
         * 2，
         * 
         */
        let firstNodeName = list[0].TaskName
        // 查找末尾节点
        let lastNodeName = list[list.length - 1].TaskName
        // 查找首位节点索引
        let firstNodeIndex = 0
        // 查找末尾节点索引
        let lastNodeIndex = 0
        dataObj.elements.forEach((item, index) => {
            if (item.name === firstNodeName) {
                firstNodeIndex = index
            }
            if (item.name === lastNodeName) {
                lastNodeIndex = index
            }
        })
        // 截取所需数组
        let temArr = dataObj.elements.slice(firstNodeIndex, lastNodeIndex + 1)
        temArr.forEach((item)=>{
            list.forEach((cItem)=>{
                if (item.name === cItem.TaskName) {
                    item.assignee = cItem.OperationMan
                }
            })
        })

        // 处理会签节点
        let paraArr = []
        let typesArr = []
        dataObj.elements.forEach((item, index) => {
            if (item.type === "ParallelGateway") {
                typesArr.push(index)
            }
        })
        paraArr = dataObj.elements.slice(typesArr[0] + 1, typesArr[1])
        console.log(paraArr, "paraArr")

        let currentNodes = []
        temArr.forEach((item, index) => {
            let nodesArr = []
            let assignee = ""
            let nodeName = item.name
            // 并行网关
            if (item.type === "ParallelGateway") {
                nodeName = "并行网关"
                nodesArr.push({
                    resourceId: item.id,
                    name: nodeName,
                    msg: "请快速办理",
                    assignee: item.assignee
                })
            } else if (item.type === "ExclusiveGateway") {
                // 排他网关
                nodeName = "排他网关"
                paraArr.forEach((pItem) => {
                    nodesArr.push({
                        resourceId: pItem.id,
                        name: pItem.name,
                        msg: "请快速办理",
                        assignee: item.assignee
                    })
                })
            } else {
                // 普通任务
                nodesArr.push({
                    type: item.type,
                    resourceId: item.id,
                    name: nodeName,
                    msg: "请快速办理",
                    assignee: item.assignee
                })
            }
            currentNodes.push({
                nodes: nodesArr,
                nodeCount: nodesArr.length,
                type: item.type
            })
        })
        console.log(currentNodes, "currentNodes")
        let curParaArr = []
        currentNodes.forEach((item, index) => {
            if (item.type === "ParallelGateway") {
                curParaArr.push(index)
            }
        })
        let prevCurArr = []
        let lastCurArr = []
        let paraIngArr = []
        let needArr = []
        let exportNodeArr = []
        let tempArr = []
        if (curParaArr.length === 1) {
            prevCurArr = currentNodes.slice(0, curParaArr[0] + 1)
            paraIngArr = currentNodes.slice(curParaArr[0] + 1)
            paraIngArr.forEach((item) => {
                needArr.push(item.nodes[0])
            })

            tempArr.push({
                nodes: needArr,
                type: 'UserTask',
                nodeCount: needArr.length,
            })
            exportNodeArr = prevCurArr.concat(tempArr)
        } else if (curParaArr.length === 2) {
            prevCurArr = currentNodes.slice(0, curParaArr[0] + 1)
            paraIngArr = currentNodes.slice(curParaArr[0] + 1, curParaArr[1])
            lastCurArr = currentNodes.slice(curParaArr[1])
            paraIngArr.forEach((item) => {
                needArr.push(item.nodes[0])
            })
            tempArr.push({
                nodes: needArr,
                type: 'UserTask',
                nodeCount: needArr.length,
            })
            exportNodeArr = prevCurArr.concat(tempArr).concat(lastCurArr)
        }
        let paraIsDrawArr = []
        exportNodeArr.forEach((item, index) => {
            if (item.type === "ParallelGateway") {
                paraIsDrawArr.push(index)
            }
            item.xStart = 100 + 200 * (index - 1)
            item.xTo = 200 + 200 * (index - 1)
            item.isDraw = true
        })
        console.log(paraIsDrawArr)
        console.log(exportNodeArr)
        if (paraIsDrawArr[1]) {
            exportNodeArr[paraIsDrawArr[1]].isDraw = false
        }
        
        
        exportNodeArr.forEach((item)=>{
            if (item.type === "UserTask") {
                item.nodes.forEach(cItem=>{
                    list.forEach((pItem)=>{
                        if (cItem.name === pItem.TaskName) {
                            cItem.time = pItem.ETime.slice(5)
                        }
                    })
                })
            }
        })
        console.log(exportNodeArr, "exportNodeArr")
    </script>
</body>

</html>